#!/usr/bin/env bash

check_modules_changed() {
  CURRENT_HASH=$(sha256sum package-lock.json 2>/dev/null | cut -d' ' -f1)
  STORED_HASH=$(cat .bred-module-hash 2>/dev/null || echo "")

  if [ "$CURRENT_HASH" != "$STORED_HASH" ]; then
    echo "Modules changed, running make prep..."
    make prep
    if [ $? ]; then
      echo "ERR make prep failed"
      exit 1
    fi
    echo "$CURRENT_HASH" > .bred-module-hash
  fi
}

cleanup() {
  echo Cleaning up...
  rm -f /tmp/bred-$$-relaunch
  echo Cleaning up... done.
}

trap cleanup SIGINT EXIT

export BRED_ORIGINAL_DIR=`pwd`
echo BRED_ORIGINAL_DIR: $BRED_ORIGINAL_DIR

cd "$(dirname "$(realpath "$0")")/.."

while true; do
  check_modules_changed
  echo 0 > /tmp/bred-$$-relaunch
  export BRED_SCRIPT_PID=$$
  if [ -n "$BRED_GDB" ] && [ "$BRED_GDB" -eq 1 ]; then
    npm run start-gdb -- $*
  else
    npm start -- $*
  fi
  CODE=$?
  echo "exit code: $CODE"
  echo /tmp/bred-$$-relaunch:
  cat /tmp/bred-$$-relaunch
  if [ "$(cat /tmp/bred-$$-relaunch)" = "1" ]; then
    echo Relaunching...
    continue
  fi
  break
done
